# {{FILE_PATH}}
"""
JWT verification for Better Auth tokens

âš ï¸ CRITICAL SECURITY:
- Uses JWKS (JSON Web Key Set) for verification (no shared secrets)
- Verifies token signature, expiry, audience, and issuer
- Better Auth uses EdDSA (Ed25519) algorithm by default
- JWKS endpoint: {{BETTER_AUTH_URL}}/api/auth/.well-known/jwks.json

ðŸ”§ DEPENDENCIES REQUIRED:
pip install PyJWT[crypto] python-jose[cryptography] cryptography
"""

import jwt
from jwt import PyJWKClient
from typing import Dict, Any
from src.config import settings
import logging


logger = logging.getLogger(__name__)


# ========================================
# JWKS Client Configuration
# ========================================

# JWKS endpoint from Better Auth
# âš ï¸ IMPORTANT: Must include /api/auth prefix (Better Auth is mounted there)
jwks_url = f"{settings.better_auth_url}/api/auth/.well-known/jwks.json"

# Create JWKS client (fetches public keys from Better Auth)
jwks_client = PyJWKClient(jwks_url)


# ========================================
# JWT Verification Functions
# ========================================

def verify_jwt(token: str) -> Dict[str, Any]:
    """
    Verify JWT token using JWKS from Better Auth

    Args:
        token: JWT token string from Authorization header

    Returns:
        Decoded token payload containing user information

    Raises:
        jwt.ExpiredSignatureError: If token has expired
        jwt.InvalidTokenError: If token is invalid or verification fails

    Example:
        >>> token = "eyJhbGc..."
        >>> payload = verify_jwt(token)
        >>> user_id = payload["sub"]

    âš ï¸ SECURITY NOTES:
    - Token signature verified using JWKS public key
    - Expiry time checked automatically
    - Audience must match BETTER_AUTH_URL
    - Algorithm must be EdDSA (Better Auth default)
    """
    try:
        # Step 1: Get signing key from JWKS (based on token's 'kid' header)
        signing_key = jwks_client.get_signing_key_from_jwt(token)

        # Step 2: Decode and verify token
        payload = jwt.decode(
            token,
            signing_key.key,
            algorithms=[settings.jwt_algorithm],  # EdDSA
            audience=settings.jwt_audience,        # {{BETTER_AUTH_URL}}
            # issuer=settings.jwt_audience,        # Optional: verify issuer
        )

        return payload

    except jwt.ExpiredSignatureError:
        logger.warning("JWT token has expired")
        raise
    except jwt.InvalidTokenError as e:
        logger.warning(f"Invalid JWT token: {e}")
        raise
    except Exception as e:
        logger.error(f"Unexpected error verifying JWT: {e}", exc_info=True)
        raise jwt.InvalidTokenError(f"Token verification failed: {e}")


def get_user_id_from_token(token: str) -> str:
    """
    Extract user ID from JWT token

    Args:
        token: JWT token string from Authorization header

    Returns:
        User ID from token's 'sub' (subject) claim

    Raises:
        jwt.InvalidTokenError: If token is invalid or missing 'sub' claim

    Example:
        >>> token = "eyJhbGc..."
        >>> user_id = get_user_id_from_token(token)
        >>> print(user_id)  # "user-123-abc"

    âš ï¸ SECURITY: This function verifies the token before extracting user ID
    """
    payload = verify_jwt(token)

    user_id = payload.get("sub")
    if not user_id:
        raise jwt.InvalidTokenError("Token missing 'sub' claim")

    return user_id


def get_user_email_from_token(token: str) -> str:
    """
    Extract user email from JWT token

    Args:
        token: JWT token string

    Returns:
        User email from token payload

    Raises:
        jwt.InvalidTokenError: If token is invalid or missing email
    """
    payload = verify_jwt(token)

    email = payload.get("email")
    if not email:
        raise jwt.InvalidTokenError("Token missing 'email' claim")

    return email


# ========================================
# Token Payload Structure (for reference)
# ========================================

# Example decoded JWT payload from Better Auth:
# {
#   "sub": "user-abc-123",           # User ID
#   "email": "user@example.com",     # User email
#   "iat": 1705680000,               # Issued at (timestamp)
#   "exp": 1705766400,               # Expiry (timestamp)
#   "aud": "{{BETTER_AUTH_URL}}",    # Audience (Better Auth URL)
#   "iss": "{{BETTER_AUTH_URL}}",    # Issuer (Better Auth URL)
# }
