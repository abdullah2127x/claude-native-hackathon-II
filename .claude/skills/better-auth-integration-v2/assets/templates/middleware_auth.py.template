# {{FILE_PATH}}
"""
Authentication middleware for FastAPI

Provides dependency injection for protected endpoints.
Extracts and verifies JWT tokens from Authorization header.

Usage:
    @router.get("/api/todos")
    async def get_todos(user_id: str = Depends(get_current_user_id)):
        # user_id is automatically extracted and verified
        return {"user_id": user_id}

⚠️ SECURITY:
- All protected endpoints MUST use get_current_user_id dependency
- Automatically returns 401 if token is invalid or missing
- Logs authentication failures for security monitoring
"""

from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from src.auth.jwt_handler import verify_jwt, get_user_id_from_token
import logging

logger = logging.getLogger(__name__)

# HTTPBearer automatically extracts "Bearer <token>" from Authorization header
security = HTTPBearer()


# ========================================
# Authentication Dependencies
# ========================================

async def get_current_user_id(
    credentials: HTTPAuthorizationCredentials = Depends(security)
) -> str:
    """
    FastAPI dependency to get current user ID from JWT token

    Automatically:
    1. Extracts Bearer token from Authorization header
    2. Verifies token using JWKS
    3. Returns user ID from token
    4. Raises 401 if token is invalid/missing

    Args:
        credentials: Automatically injected by FastAPI (from Authorization header)

    Returns:
        User ID (string) from verified JWT token

    Raises:
        HTTPException (401): If token is invalid, expired, or missing

    Example:
        @router.get("/api/todos")
        async def get_todos(user_id: str = Depends(get_current_user_id)):
            # user_id is guaranteed to be valid here
            todos = db.query(Todo).filter(Todo.user_id == user_id).all()
            return todos
    """
    try:
        # Extract token from credentials
        token = credentials.credentials

        # Verify and extract user ID
        user_id = get_user_id_from_token(token)

        return user_id

    except Exception as e:
        logger.warning(f"Authentication failed: {e}")
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid authentication credentials",
            headers={"WWW-Authenticate": "Bearer"},
        )


async def get_current_user_payload(
    credentials: HTTPAuthorizationCredentials = Depends(security)
) -> dict:
    """
    FastAPI dependency to get full JWT payload

    Use this when you need more than just user ID (e.g., email, roles)

    Returns:
        Full JWT payload dictionary

    Example:
        @router.get("/api/profile")
        async def get_profile(payload: dict = Depends(get_current_user_payload)):
            return {
                "user_id": payload["sub"],
                "email": payload["email"],
            }
    """
    try:
        token = credentials.credentials
        payload = verify_jwt(token)
        return payload
    except Exception as e:
        logger.warning(f"Authentication failed: {e}")
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid authentication credentials",
            headers={"WWW-Authenticate": "Bearer"},
        )


# ========================================
# Optional: User Model Dependency
# ========================================

# If you have a User model and want to load the full user object:
#
# from src.models.user import User
# from src.db.database import get_session
# from sqlmodel import Session, select
#
# async def get_current_user(
#     user_id: str = Depends(get_current_user_id),
#     session: Session = Depends(get_session)
# ) -> User:
#     """
#     Get current User model from database
#
#     Returns:
#         User model with all fields
#     """
#     user = session.exec(select(User).where(User.id == user_id)).first()
#     if not user:
#         raise HTTPException(
#             status_code=status.HTTP_404_NOT_FOUND,
#             detail="User not found"
#         )
#     return user
